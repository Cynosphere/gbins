#include "StdAfx.h"

#include "sigscan/sigscan.h"
#include "gm_lua.h"

#ifdef __WIN32__
#include <windows.h>
#else
#include <dlfcn.h>
#endif

#define DECLARE_FUNCS(x) x##_t g##x = NULL;

FUNCLIST(DECLARE_FUNCS)
lua_resume_t glua_resume = NULL;

struct FunctionSig {
	const char* sig;
	const char* mask;
	void* pointer;
};

FunctionSig LuaSigs[] = {
	{
		"\x53\x55\x8b\x6c\x24\x0c\x56\x57\x8b\x7c\x24\x18\x68\x00\x00\x00\x00",
		"xxxxxxxxxxxxx????",
		&glua_newstate
	},
	{
		"\x8b\x44\x24\x04\x8b\x48\x14\x56\x8b\x71\x18\x8b\x56\x7c\x57\x52\x56\xe8\x00\x00\x00\x00\x6a\x01",
		"xxxxxxxxxxxxxxxxxx????xx",
		&glua_close
	},
	{
		"\x56\x8b\x74\x24\x08\x8b\x46\x14\x8b\x08\x3b\x88\xf8\x00\x00\x00\x72\x00\x56\xe8\x00\x00\x00\x00\x83\xc4\x04\x56\xe8\x00\x00\x00\x00\x8b\x4e\x5c\x83\xc4\x04",
		"xxxxxxxxxxxxxxxxx?xx????xxxxx????xxxxxx",

		&glua_newthread
	},
	{
		"\x8b\x44\x24\x04\x8b\x48\x14\x8b\x54\x24\x08\x8b\x81\xfc\x00\x00\x00\x89\x91\xfc\x00\x00\x00\xc3",
		"xxxxxxxxxxxxxxxxxxxxxxxx",
		&glua_atpanic
	},
	{
		"\x8b\x4c\x24\x04\x8b\x41\x5c\x2b\x41\x74\xc1\xf8\x04\xc3",
		"xxxxxxxxxxxxxx",
		&glua_gettop
	},
	{
		"\x8b\x4c\x24\x08\x85\xc9\x8b\x44\x24\x04\x7c\x00\x8b\x50\x74\xc1\xe1\x04\x03\xd1\x39\x50\x5c\x73\x00\xba\x00\x00\x00\x00\x57\x90\x8b\x78\x5c",
		"xxxxxxxxxxx?xxxxxxxxxxxx?x????xxxxx",
		&glua_settop
	},
	{
		"\x8b\x44\x24\x08\x56\x8b\x74\x24\x08\x8b\xce\xe8\x00\x00\x00\x00\x8b\x10\x8b\x4e\x5c\x89\x11\x8b\x50\x04\x89\x51\x04\x8b\x40\x08\x89\x41\x08\x83\x46\x5c\x10\x5e\xc3",
		"xxxxxxxxxxxx????xxxxxxxxxxxxxxxxxxxxxxxxx",
		&glua_pushvalue
	},
	{
		"\x8b\x44\x24\x08\x56\x8b\x74\x24\x08\x8b\xce\xe8\x00\x00\x00\x00\x83\xc0\x10\x3b\x46\x5c\x73\x00\x8d\x48\xf0\xeb\x00\x8d\x49\x00\x8b\x10",
		"xxxxxxxxxxxx????xxxxxxx?xxxx?xxxxx",
		&glua_remove
	},
	{
		"\x8b\x44\x24\x08\x56\x8b\x74\x24\x08\x8b\xce\xe8\x00\x00\x00\x00\x8b\x56\x5c\x3b\xd0\x76\x00\x8d\x4a\xf0\x57\xeb\x00\x8d\x49\x00\x8b\x39",
		"xxxxxxxxxxxx????xxxxxx?xxxxx?xxxxx",
		&glua_insert
	},
	{
		"\x56\x8b\x74\x24\x08\x57\x8b\x7c\x24\x10\x81\xff\x00\x00\x00\x00\x75\x00\x8b\x46\x70\x3b\x46\x10\x75\x00\x68\x00\x00\x00\x00\x56\xe8\x00\x00\x00\x00\x83\xc4\x08\x8b\xc7",
		"xxxxxxxxxxxx????x?xxxxxxx?x????xx????xxxxx",
		&glua_replace
	},
	{
		"\x8b\x44\x24\x08\x3d\x00\x00\x00\x00\x53\x56\xbb\x00\x00\x00\x00\x7f\x00\x8b\x74\x24\x0c\x8b\x4e\x5c\x8b\xd1\x2b\x56\x74\xc1\xfa\x04",
		"xxxxx????xxx????x?xxxxxxxxxxxxxxx",
		&glua_checkstack
	},
	{
		"\x56\x8b\x74\x24\x0c\x57\x8b\x7c\x24\x0c\x3b\xfe\x74\x00\x53\x8b\x5c\x24\x18\x8b\xc3\xf7\xd8\xc1\xe0\x04\x01\x47\x5c\x85\xdb\x7e\x00\x33\xd2",
		"xxxxxxxxxxxxx?xxxxxxxxxxxxxxxxxx?xx",
		&glua_xmove
	},
	{
		"\x8b\x44\x24\x08\x8b\x4c\x24\x04\x83\xec\x10\xe8\x00\x00\x00\x00\x83\x78\x08\x03\x74\x00\x8d\x0c\x24\x51\x50\xe8\x00\x00\x00\x00\x83\xc4\x08\x85\xc0\x75\x00\x83\xc4\x10",
		"xxxxxxxxxxxx????xxxxx?xxxxxx????xxxxxx?xxx",
		&glua_isnumber
	},
	{
		"\x8b\x44\x24\x08\x8b\x4c\x24\x04\xe8\x00\x00\x00\x00\x3d\x00\x00\x00\x00\x74\x00\x8b\x40\x08\x83\xf8\x04\x74\x00\x83\xf8\x03\x74\x00",
		"xxxxxxxxx????x????x?xxxxxxx?xxxx?",
		&glua_isstring
	},
	{
		"\x8b\x44\x24\x08\x8b\x4c\x24\x04\xe8\x00\x00\x00\x00\x83\x78\x08\x06\x75\x00\x8b\x00\x80\x78\x08\x00\x74\x00\xb8\x00\x00\x00\x00",
		"xxxxxxxxx????xxxxx?xxxxxxx?x????",
		&glua_iscfunction
	},
	// no lua_isuserdata
	{
		"\x8b\x44\x24\x08\x8b\x4c\x24\x04\xe8\x00\x00\x00\x00\x3d\x00\x00\x00\x00\x75\x00\x83\xc8\xff",
		"xxxxxxxxx????x????x?xxx",
		&glua_type
	},
	// lua_typename is modified
	{
		"\x8b\x44\x24\x08\x56\x57\x8b\x7c\x24\x0c\x8b\xcf\xe8\x00\x00\x00\x00\x8b\xf0\x8b\x44\x24\x14\x8b\xcf\xe8\x00\x00\x00\x00\x81\xfe\x00\x00\x00\x00\x74\x00\x3d\x00\x00\x00\x00\x74\x00\x8b\x4e\x08\x3b\x48\x08",
		"xxxxxxxxxxxxx????xxxxxxxxx????xx????x?x????x?xxxxxx",
		&glua_equal
	},
	{
		"\x8b\x44\x24\x08\x56\x57\x8b\x7c\x24\x0c\x8b\xcf\xe8\x00\x00\x00\x00\x8b\xf0\x8b\x44\x24\x14\x8b\xcf\xe8\x00\x00\x00\x00\x81\xfe\x00\x00\x00\x00\x74\x00\x3d\x00\x00\x00\x00\x74\x00\x50\x56\xe8\x00\x00\x00\x00",
		"xxxxxxxxxxxxx????xxxxxxxxx????xx????x?x????x?xxx????",
		&glua_rawequal
	},
	{
		"\x8b\x44\x24\x08\x56\x8b\x74\x24\x08\x57\x8b\xce\xe8\x00\x00\x00\x00\x8b\xf8\x8b\x44\x24\x14\x8b\xce\xe8\x00\x00\x00\x00\x81\xff\x00\x00\x00\x00\x74\x00\x3d\x00\x00\x00\x00\x74\x00\x50\x57\x56",
		"xxxxxxxxxxxxx????xxxxxxxxx????xx????x?x????x?xxx",
		&glua_lessthan
	},
	{
		"\x8b\x44\x24\x08\x8b\x4c\x24\x04\x83\xec\x10\xe8\x00\x00\x00\x00\x83\x78\x08\x03\x74\x00\x8d\x0c\x24\x51\x50\xe8\x00\x00\x00\x00\x83\xc4\x08\x85\xc0\x75\x00\xd9\xee\x83\xc4\x10",
		"xxxxxxxxxxxx????xxxxx?xxxxxx????xxxxxx?xxxxx",
		&glua_tonumber
	},
	{
		"\x8b\x44\x24\x08\x8b\x4c\x24\x04\x83\xec\x1c\xe8\x00\x00\x00\x00\x83\x78\x08\x03\x74\x00\x8d\x4c\x24\x0c\x51\x50\xe8\x00\x00\x00\x00\x83\xc4\x08\x85\xc0\x75\x00\x83\xc4\x1c",
		"xxxxxxxxxxxx????xxxxx?xxxxxxx????xxxxxx?xxx",
		&glua_tointeger
	},
	{
		"\x8b\x44\x24\x08\x8b\x4c\x24\x04\xe8\x00\x00\x00\x00\x8b\x48\x08\x85\xc9\x74\x00\x83\xf9\x01\x75\x00\x83\x38\x00\x74\x00\xb8\x00\x00\x00\x00",
		"xxxxxxxxx????xxxxxx?xxxx?xxxx?x????",
		&glua_toboolean
	},
	{
		"\x56\x8b\x74\x24\x08\x57\x8b\x7c\x24\x10\x8b\xc7\x8b\xce\xe8\x00\x00\x00\x00\x83\x78\x08\x04\x74\x00",
		"xxxxxxxxxxxxxxx????xxxxx?",
		&glua_tolstring
	},
	{
		"\x8b\x44\x24\x08\x56\x57\x8b\x7c\x24\x0c\x8b\xcf\xe8\x00\x00\x00\x00\x8b\xf0\x8b\x46\x08\x83\xc0\xfd\x83\xf8\x04\x77\x00",
		"xxxxxxxxxxxxx????xxxxxxxxxxxx?",
		&glua_objlen
	},
	// no lua_tocfunction
	{
		"\x8b\x44\x24\x08\x8b\x4c\x24\x04\xe8\x00\x00\x00\x00\x8b\x48\x08\x83\xe9\x02\x74\x00\x83\xe9\x05\x74\x00\x33\xc0",
		"xxxxxxxxx????xxxxxxx?xxxx?xx",
		&glua_touserdata
	},
	{
		"\x8b\x44\x24\x08\x8b\x4c\x24\x04\xe8\x00\x00\x00\x00\x83\x78\x08\x08\x74\x00\x33\xc0\xc3\x8b\x00",
		"xxxxxxxxx????xxxxx?xxxxx",
		&glua_tothread
	},
	{
		"\x56\x8b\x74\x24\x0c\x57\x8b\x7c\x24\x0c\x8b\xc6\x8b\xcf\xe8\x00\x00\x00\x00\x8b\x48\x08\x83\xc1\xfe\x83\xf9\x06\x77\x00",
		"xxxxxxxxxxxxxxx????xxxxxxxxxx?",
		&glua_topointer
	},
	{
		"\x8b\x44\x24\x04\x8b\x48\x5c\xc7\x41\x08\x00\x00\x00\x00\x83\x40\x5c\x10\xc3",
		"xxxxxxxxxxxxxxxxxxx",
		&glua_pushnil
	},
	{
		"\x8b\x44\x24\x04\xdd\x44\x24\x08\x8b\x48\x5c\xdd\x19\xc7\x41\x08\x03\x00\x00\x00\x83\x40\x5c\x10\xc3",
		"xxxxxxxxxxxxxxxxxxxxxxxxx",
		&glua_pushnumber
	},
	{
		"\x8b\x44\x24\x04\xdb\x44\x24\x08\x8b\x48\x5c\xc7\x41\x08\x03\x00\x00\x00\xdd\x19\x83\x40\x5c\x10",
		"xxxxxxxxxxxxxxxxxxxxxxxx",
		&glua_pushinteger
	},
	{
		"\x56\x8b\x74\x24\x08\x8b\x46\x14\x8b\x08\x3b\x88\xf8\x00\x00\x00\x57\x72\x00\x56\xe8\x00\x00\x00\x00\x83\xc4\x04\x8b\x54\x24\x14\x8b\x44\x24\x10\x8b\x7e\x5c",
		"xxxxxxxxxxxxxxxxxx?xx????xxxxxxxxxxxxxx",
		&glua_pushlstring
	},
	{
		"\x55\x8b\x6c\x24\x0c\x85\xed\x75\x00\x8b\x44\x24\x08\x8b\x48\x5c\x89\x69\x08\x83\x40\x5c\x10\x5d\xc3\x8b\xc5",
		"xxxxxxxx?xxxxxxxxxxxxxxxxxx",
		&glua_pushstring
	},
	{
		"\x56\x8b\x74\x24\x08\x8b\x46\x14\x8b\x08\x3b\x88\xf8\x00\x00\x00\x72\x00\x56\xe8\x00\x00\x00\x00\x83\xc4\x04\x8b\x54\x24\x10\x8b\x44\x24\x0c\x52",
		"xxxxxxxxxxxxxxxxx?xx????xxxxxxxxxxxx",
		&glua_pushvfstring
	},
	{
		"\x56\x8b\x74\x24\x08\x8b\x46\x14\x8b\x08\x3b\x88\xf8\x00\x00\x00\x72\x00\x56\xe8\x00\x00\x00\x00\x83\xc4\x04\x8b\x44\x24\x0c\x8d\x54\x24\x10",
		"xxxxxxxxxxxxxxxxx?xx????xxxxxxxxxxx",
		&glua_pushfstring
	},
	{
		"\x56\x8b\x74\x24\x08\x8b\x46\x14\x8b\x08\x3b\x88\xf8\x00\x00\x00\x57\x72\x00\x56\xe8\x00\x00\x00\x00\x83\xc4\x04\x8b\x46\x70\x3b\x46\x10",
		"xxxxxxxxxxxxxxxxxx?xx????xxxxxxxxx",
		&glua_pushcclosure
	},
	{
		"\x8b\x44\x24\x04\x8b\x48\x5c\x33\xd2\x39\x54\x24\x08\xc7\x41\x08\x01\x00\x00\x00\x0f\x95\xc2\x89\x11\x83\x40\x5c\x10\xc3",
		"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
		&glua_pushboolean
	},
	{
		"\x8b\x44\x24\x04\x8b\x48\x5c\x8b\x54\x24\x08\x89\x11\xc7\x41\x08\x02\x00\x00\x00\x83\x40\x5c\x10\xc3",
		"xxxxxxxxxxxxxxxxxxxxxxxxx",
		&glua_pushlightuserdata
	},
	{
		"\x8b\x44\x24\x04\x8b\x48\x5c\x89\x01\xc7\x41\x08\x08\x00\x00\x00\x8b\x48\x14\x83\x40\x5c\x10\x33\xd2\x39\x41\x18\x0f\x94\xc2\x8b\xc2",
		"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
		&glua_pushthread
	},
	{
		"\x8b\x44\x24\x08\x56\x8b\x74\x24\x08\x8b\xce\xe8\x00\x00\x00\x00\x8b\x4e\x5c\x83\xc1\xf0",
		"xxxxxxxxxxxx????xxxxxx",
		&glua_gettable
	},
	{
		"\x8b\x44\x24\x08\x83\xec\x10\x53\x56\x8b\x74\x24\x1c\x57\x8b\xce\xe8\x00\x00\x00\x00\x8b\x54\x24\x28\x8b\xf8\x8b\xc2\x8d\x58\x01\x8a\x08\x83\xc0\x01\x84\xc9\x75\x00\x2b\xc3\x50\x52\x56\xe8\x00\x00\x00\x00\x89\x44\x24\x18\x8b\x46\x5c\x50\x8d\x4c\x24\x1c\x51\x57\x56\xc7\x44\x24\x30\x04\x00\x00\x00",
		"xxxxxxxxxxxxxxxxx????xxxxxxxxxxxxxxxxxxx?xxxxxx????xxxxxxxxxxxxxxxxxxxxxxx",
		&glua_getfield
	},
	{
		"\x8b\x44\x24\x08\x56\x8b\x74\x24\x08\x8b\xce\xe8\x00\x00\x00\x00\x8b\x4e\x5c\x8b\x10\x83\xe9\x10\x51\x52\xe8\x00\x00\x00\x00\x8b\x4e\x5c",
		"xxxxxxxxxxxx????xxxxxxxxxxx????xxx",
		&glua_rawget
	},
	{
		"\x8b\x44\x24\x08\x56\x8b\x74\x24\x08\x8b\xce\xe8\x00\x00\x00\x00\x8b\x4c\x24\x10\x8b\x10\x51\x52\xe8\x00\x00\x00\x00\x8b\x10\x8b\x4e\x5c",
		"xxxxxxxxxxxx????xxxxxxxxx????xxxxx",
		&glua_rawgeti
	},
	{
		"\x56\x8b\x74\x24\x08\x8b\x46\x14\x8b\x08\x3b\x88\xf8\x00\x00\x00\x57\x72\x00\x56\xe8\x00\x00\x00\x00\x83\xc4\x04\x8b\x54\x24\x14\x8b\x44\x24\x10\x8b\x7e\x5c\x52\x50\x56\xe8\x00\x00\x00\x00\x83\xc4\x0c\x89\x07\xc7\x47\x08\x05\x00\x00\x00",
		"xxxxxxxxxxxxxxxxxx?xx????xxxxxxxxxxxxxxxxxx????xxxxxxxxxxxx",
		&glua_createtable
	},
	{
		"\x56\x8b\x74\x24\x08\x8b\x46\x14\x8b\x08\x3b\x88\xf8\x00\x00\x00\x72\x00\x56\xe8\x00\x00\x00\x00\x83\xc4\x04\x8b\x46\x70\x3b\x46\x10",
		"xxxxxxxxxxxxxxxxx?xx????xxxxxxxxx",
		&glua_newuserdata
	},
	{
		"\x8b\x44\x24\x08\x56\x8b\x74\x24\x08\x8b\xce\xe8\x00\x00\x00\x00\x8b\x48\x08\x8b\xd1\x83\xea\x05\x74\x00\x83\xea\x02\x74\x00\x8b\x46\x14\x8b\x4c\x88\x40\xeb\x00",
		"xxxxxxxxxxxx????xxxxxxxxx?xxxx?xxxxxxxx?",
		&glua_getmetatable
	},
	{
		"\x8b\x44\x24\x08\x56\x8b\x74\x24\x08\x8b\xce\xe8\x00\x00\x00\x00\x8b\x48\x08\x83\xe9\x06\x74\x00\x83\xe9\x01\x74\x00\x83\xe9\x01\x74\x00\x8b\x46\x5c\xc7\x40\x08\x00\x00\x00\x00\x83\x46\x5c\x10\x5e",
		"xxxxxxxxxxxx????xxxxxxx?xxxx?xxxx?xxxxxxxxxxxxxxx",
		&glua_getfenv
	},
	{
		"\x8b\x44\x24\x08\x56\x8b\x74\x24\x08\x8b\xce\xe8\x00\x00\x00\x00\x8b\x4e\x5c\x8d\x51\xf0\x52\x83\xc1\xe0\x51\x50\x56\xe8\x00\x00\x00\x00\x83\x46\x5c\xe0\x83\xc4\x10\x5e",
		"xxxxxxxxxxxx????xxxxxxxxxxxxxx????xxxxxxxx",
		&glua_settable
	},
	{
		"\x8b\x44\x24\x08\x83\xec\x10\x53\x56\x8b\x74\x24\x1c\x57\x8b\xce\xe8\x00\x00\x00\x00\x8b\x54\x24\x28\x8b\xf8\x8b\xc2\x8d\x58\x01\x8a\x08\x83\xc0\x01\x84\xc9\x75\x00\x2b\xc3\x50\x52\x56\xe8\x00\x00\x00\x00\x89\x44\x24\x18\x8b\x46\x5c\x83\xe8\x10\x50\x8d\x4c\x24\x1c\x51\x57\x56\xc7\x44\x24\x30\x04\x00\x00\x00",
		"xxxxxxxxxxxxxxxxx????xxxxxxxxxxxxxxxxxxx?xxxxxx????xxxxxxxxxxxxxxxxxxxxxxxxxx",
		&glua_setfield
	},
	{
		"\x8b\x44\x24\x08\x53\x56\x8b\x74\x24\x0c\x57\x8b\xce\xe8\x00\x00\x00\x00\x8b\x7e\x5c",
		"xxxxxxxxxxxxxx????xxx",
		&glua_rawset
	},
	{
		"\x8b\x44\x24\x08\x53\x56\x57\x8b\x7c\x24\x10\x8b\xcf\xe8\x00\x00\x00\x00\x8b\x77\x5c\x8b\xd8",
		"xxxxxxxxxxxxxx????xxxxx",
		&glua_rawseti
	},
	{
		"\x8b\x44\x24\x08\x56\x57\x8b\x7c\x24\x0c\x8b\xcf\xe8\x00\x00\x00\x00\x8b\x4f\x5c\x83\x79\xf8\x00\x75\x00\x33\xc9\xeb\x00\x8b\x49\xf0\x8b\x50\x08\x8b\xf2\x83\xee\x05",
		"xxxxxxxxxxxxx????xxxxxxxx?xxx?xxxxxxxxxxx",
		&glua_setmetatable
	},
	{
		"\x8b\x44\x24\x08\x56\x8b\x74\x24\x08\x57\x8b\xce\xbf\x00\x00\x00\x00\xe8\x00\x00\x00\x00",
		"xxxxxxxxxxxxx????x????",
		&glua_setfenv
	},
	{
		"\x8b\x44\x24\x08\x56\x8b\x74\x24\x08\x8b\x4e\x5c\x57\x8b\x7c\x24\x14\x83\xc0\x01\xc1\xe0\x04",
		"xxxxxxxxxxxxxxxxxxxxxxx",
		&glua_call
	},
	{
		"\x8b\x44\x24\x10\x83\xec\x08\x85\xc0\x56\x8b\x74\x24\x10\x75\x00\x33\xc9\xeb\x00",
		"xxxxxxxxxxxxxxx?xxx?",
		&glua_pcall
	},
	// no lua_cpcall
	{
		"\x83\xec\x14\x56\x57\x8b\x7c\x24\x2c\x85\xff\x75\x00\xbf\x00\x00\x00\x00",
		"xxxxxxxxxxxx?x????",
		&glua_load
	},
	/*
	{
		"\x8B\x4C\x24\x04\x8B\x41\x68\x83\xE8\x10\x83\x78\x08\x06\x75\x22",
		"xxxxxxxxxxxxxxxx",
		16,
		&glua_dump
	},
	*/
	{
		"\x56\x8b\x74\x24\x08\x66\x8b\x46\x50\x66\x3b\x46\x52\x76\x00\x68\x00\x00\x00\x00\x56",
		"xxxxxxxxxxxxxx?x????x",
		&glua_yield
	},
	{
		"\x56\x8b\x74\x24\x08\x8a\x46\x48\x3c\x01\x74\x00\x84\xc0\x75\x00\x8b\x46\x70\x3b\x46\x10\x74\x00",
		"xxxxxxxxxxx?xxx?xxxxxxx?",
		&glua_resume
	},
	{
		"\x8b\x44\x24\x04\x0f\xb6\x40\x48\xc3",
		"xxxxxxxxx",
		&glua_status
	},
	{
		"\x8b\x44\x24\x08\x53\x8b\x5c\x24\x08\x56\x8b\x73\x14\x57\x33\xff\x83\xf8\x07",
		"xxxxxxxxxxxxxxxxxxx",
		&glua_gc
	},
	{
		"\x8b\x44\x24\x04\x50\xe8\x00\x00\x00\x00\x83\xc4\x04\x33\xc0",
		"xxxxxx????xxxxx",
		&glua_error
	},
	{
		"\x8b\x44\x24\x08\x56\x8b\x74\x24\x08\x8b\xce\xe8\x00\x00\x00\x00\x8b\x4e\x5c\x8b\x10\x83\xe9\x10\x51\x52\x56\xe8\x00\x00\x00\x00\x83\xc4\x0c",
		"xxxxxxxxxxxx????xxxxxxxxxxxx????xxx",
		&glua_next
	},
	{
		"\x56\x57\x8b\x7c\x24\x10\x83\xff\x02\x7c\x00\x8b\x74\x24\x0c\x8b\x46\x14\x8b\x08\x3b\x88\xf8\x00\x00\x00", 
		"xxxxxxxxxx?xxxxxxxxxxxxxxx",
		&glua_concat
	},
	// no lua_getallocf
	// no lua_setallocf
	{
		"\x8b\x4c\x24\x08\x85\xc9\x8b\x54\x24\x04\x8b\x42\x70\x7e\x00\x56\x8b\x72\x10",
		"xxxxxxxxxxxxxx?xxxx",
		&glua_getstack
	},
	{
		"\x53\x55\x8b\x6c\x24\x10\x56\x8b\x74\x24\x18\x33\xdb\x33\xc9\x80\x7d\x00\x3e",
		"xxxxxxxxxxxxxxxxxxx",
		&glua_getinfo
	},
	{
		"\x8b\x44\x24\x08\x8b\x80\x24\x02\x00\x00\x53\x8b\x5c\x24\x08\x8b\x53\x10\x55\x56\x8d\x0c\x40",
		"xxxxxxxxxxxxxxxxxxxxxxx",
		&glua_getlocal
	},
	{
		"\x8b\x44\x24\x08\x8b\x80\x24\x02\x00\x00\x53\x8b\x5c\x24\x08\x8b\x53\x10\x56\x8d\x0c\x40",
		"xxxxxxxxxxxxxxxxxxxxxx",
		&glua_setlocal
	},
	{
		"\x8b\x44\x24\x08\x57\x8b\x7c\x24\x08\x8b\xcf\xe8\x00\x00\x00\x00\x83\x78\x08\x06\x74\x00\x33\xc0\x5f\xc3\x8b\x00\x80\x78\x08\x00",
		"xxxxxxxxxxxx????xxxxx?xxxxxxxxxx",
		&glua_getupvalue
	},
	{
		"\x8b\x44\x24\x08\x57\x8b\x7c\x24\x08\x8b\xcf\xe8\x00\x00\x00\x00\x83\x78\x08\x06\x74\x00\x33\xc0\x5f\xc3\x8b\x08\x80\x79\x08\x00",
		"xxxxxxxxxxxx????xxxxx?xxxxxxxxxx",
		&glua_setupvalue
	},
	{
		"\x8b\x54\x24\x08\x85\xd2\x74\x00\x8b\x4c\x24\x0c\x85\xc9\x75\x00",
		"xxxxxxx?xxxxxxx?",
		&glua_sethook
	},
	{
		"\x8b\x44\x24\x04\x8b\x40\x38\xc3",
		"xxxxxxxx",
		&glua_gethook
	},
	{
		"\x8b\x44\x24\x04\x0f\xb6\x40\x54\xc3",
		"xxxxxxxxx",
		&glua_gethookmask
	},
	{
		"\x8b\x44\x24\x04\x8b\x40\x20\xc3",
		"xxxxxxxx",
		&glua_gethookcount
	},
};

#if defined __WIN32__
#define MODULE_T HMODULE
#define OPEN_LIBRARY(x) LoadLibrary("garrysmod/bin/" x ".dll")
#define CLOSE_LIBRARY FreeLibrary
#define GETSYMBOL GetProcAddress
#elif defined __LINUX__
#define MODULE_T void*
#define OPEN_LIBRARY(x) dlopen( ##x ".so", RTLD_FIRST)
#define CLOSE_LIBRARY dlclose
#define GETSYMBOL dlysm
#elif defined __MACOSX__
#define MODULE_T void*
#define OPEN_LIBRARY(x) dlopen( ##x ".so", RTLD_FIRST)
#define CLOSE_LIBRARY dlclose
#define GETSYMBOL dlysm
#endif

#define GETFUNCS(x) g##x = (x##_t) GETSYMBOL(lua_shared, #x);

MODULE_T lua_shared = NULL;

void InitLuaAPI() {
	lua_shared = OPEN_LIBRARY("lua_shared");
	FUNCLIST(GETFUNCS)
	glua_resume = (lua_resume_t) GETSYMBOL(lua_shared, "lua_resume_real");
	/*
	CSigScan::sigscan_dllfunc = (void* (*)(const char*, int*))GetProcAddress(lua_shared, "CreateInterface");
	CSigScan::GetDllMemInfo();
	for (long i = 0; i < sizeof(LuaSigs)/sizeof(LuaSigs[0]); ++i) {
		FunctionSig sig = LuaSigs[i];
		CSigScan sigscan;
		sigscan.Init((unsigned char*)sig.sig, (char*)sig.mask, strlen(sig.mask));
		if (sigscan.is_set) *((void**)sig.pointer) = sigscan.sig_addr;
	}
	*/
}

void ShutdownLuaAPI() {
	CLOSE_LIBRARY(lua_shared);
}

#define DEBUG_FUNCS(x) if (g##x) printf("Found %s at %p\n", #x, g##x); else printf("Failed to find %s.\n", #x);

void DebugLuaAPI() {
	FUNCLIST(DEBUG_FUNCS)
}